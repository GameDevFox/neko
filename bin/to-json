#!/usr/bin/env node
// -*- mode: js2 -*-

var exec = require("child_process").execSync;

var _ = require("lodash");
var concat = require("concat-stream");

var opt = require("node-getopt").create([
    ["a", "array", "array mode"],
    ["o", "object=KEY", "object mode"],
    ["t", "trim-top=NUM", "trim NUM limes from the top"],
    ["b", "trim-bottom=NUM", "trim NUM limes from the bottom"],
    ["s", "split", "split args"],
    ["h", "help", "display this help"]
])
        .bindHelp()
        .parseSystem();

// console.log(opt);

var options = opt.options;

// Option validation
if(options.array && options.object)
    throw new Error("Incompatible options: --array and --object. Please select only one.");

// Start
var readStdin = new Promise((resolve, reject) => {
    process.stdin.pipe(concat(input => {
        resolve(input.toString());
    }));
});

var chain = readStdin.then(input => input.split(/\n/))
    .then(lines => _.filter(lines, line => line.trim().length != 0));

// Options
if(options["trim-bottom"])
    chain = chain.then(lines => lines.slice(0, lines.length-options["trim-bottom"]));

if(options["trim-top"])
    chain = chain.then(lines => lines.slice(options["trim-top"]));

if(options.split)
    chain = chain.then(lines => _.map(lines, line  => line.split(/\s+/)))

if(options.array) {
    chain = chain.then(lines => _.map(lines, line => [line]));
}

if(options.object) {
    chain = chain.then(lines => _.map(lines, line => {
        var key = options.object;
        var result = {};

        result[key] = line;
        return result;
    }));
}

chain.then(result => console.log(result));
