#!/usr/bin/env node
// -*- mode: js2 -*-

var _ = require("lodash");
var c = require("./json-common.js");

var opt = c.getOpt([
    ["n", "name=NAME", "name of the input variable"],
    ["p", "pretty", "output pretty json"],
    ["t", "type=TYPE", "convert to result to given type"],
]);

var args = opt.argv;
var key = args[0];
var cmdArgs = args.slice(1);

var options = opt.options;

var varName = options.name ? options.name : "x";

// Start
var stdinP = c.readStdinP().then(input => JSON.parse(input));

var cmdTpl = cmdArgs.join(" ");
var template = _.template(cmdTpl);

var chain = stdinP.then(input => {
    return _.map(input, item => {
        var input = c.toObj(item, varName);

        var output = undefined;
        try {
            output = c.exec(template, input).trim();
        } catch(e) {
            process.stderr.write(e.toString());
        }

        if(options.type) {
            switch(options.type.charAt(0)) {
            case "n":
                output = parseFloat(output);
                break;
            case "d":
                output = new Date(output);
                break;
            }
        }

        input[key] = output;

        return input;
    });
})
        .then(result => console.log(JSON.stringify(result, null, options.pretty ? 2 : undefined)));
