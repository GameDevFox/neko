#!/usr/bin/env node
// -*- mode: js2 -*-

var _ = require("lodash");
var c = require("./json-common");

var opt = c.getOpt([
    ["n", "name=NAME", "name of the input variable"],
    ["o", "std-out", "print command result to stdout instad of returning json"],
    ["p", "pretty", "output pretty json"],
]);

var args = opt.argv;
var options = opt.options;

var varName = options.name ? options.name : "x";

// Start
var stdinP = c.readStdinP().then(input => JSON.parse(input));

var cmdTpl = args.join(" ");
var template = _.template(cmdTpl);

var chain = stdinP.then(input => {
    return _.map(input, item => {
        var input = c.toObj(item, varName);
        var output = c.exec(template, input).trim();

        if(options["std-out"])
            process.stdout.write(output);

        return output;
    });
})

if(!options["std-out"])
    chain.then(result => console.log(JSON.stringify(result, null, options.pretty ? 2 : undefined)));
