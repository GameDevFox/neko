#!/usr/bin/env node
// -*- mode: js2 -*-

var _ = require("lodash");
var c = require("./json-common.js");

var opt = c.getOpt([
    ["n", "name=NAME", "name of the input variable"],
    ["p", "pretty", "output pretty json"],
]);

var args = opt.argv;
var key = args[0];
var cmdArgs = args.slice(1);

var options = opt.options;

var varName = options.name ? options.name : "x";

// Start
var stdinP = c.readStdinP().then(input => JSON.parse(input));

var cmdTpl = cmdArgs.join(" ");
var template = _.template(cmdTpl);

var chain = stdinP.then(input => {
    return _.map(input, item => {
        var input = c.toObj(item, varName);

        try {
            var output = c.exec(template, input).trim();
        } catch(e) {
            process.stderr.write(e.toString());
        }

        input[key] = output;

        return input;
    });
})
        .then(result => console.log(JSON.stringify(result, null, options.pretty ? 2 : undefined)));
