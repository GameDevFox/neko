#!/usr/bin/env node
// -*- mode: js2 -*-

var exec = require("child_process").execSync;

var _ = require("lodash");
var concat = require("concat-stream");
var opt = require("node-getopt").create([
    ["h", "help", "display this help"],
    ["n", "name=NAME", "name of the input variable"],
    ["p", "pretty", "output pretty json"],
])
        .bindHelp()
        .parseSystem();

var args = opt.argv;
var key = args[0];
var cmdArgs = args.slice(1);

var options = opt.options;

var varName = options.name ? options.name : "x";

// Start
var readStdin = new Promise((resolve, reject) => {
    process.stdin.pipe(concat(input => {
        var inputStr = input.toString();
        var json = JSON.parse(inputStr);
        resolve(json);
    }));
});

var cmdTpl = cmdArgs.join(" ");
var template = _.template(cmdTpl);

var chain = readStdin.then(input => {
    return _.map(input, item => {
        var newItem = {};
        newItem[varName] = item;

        console.log(newItem);

        var cmd = template(newItem);
        var stdOut = exec(cmd).toString().trim();

        item[key] = stdOut;

        return item;
    });
})
        .then(result => console.log(JSON.stringify(result, null, options.pretty ? 2 : undefined)));
