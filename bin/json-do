#!/usr/bin/env node
// -*- mode: js2 -*-

var exec = require("child_process").execSync;

var _ = require("lodash");
var concat = require("concat-stream");
var opt = require("node-getopt").create([
    ["n", "name=NAME", "name of the input variable"],
    ["o", "std-out", "print command result to stdout instad of returning json"],
    ["p", "pretty", "output pretty json"],
])
        .parseSystem();

var args = opt.argv;
var options = opt.options;

var varName = options.name ? options.name : "x";

// Start
var readStdin = new Promise((resolve, reject) => {
    process.stdin.pipe(concat(input => {
        var inputStr = input.toString();
        var json = JSON.parse(inputStr);
        resolve(json);
    }));
});

var cmdTpl = args.join(" ");
var template = _.template(cmdTpl);

var chain = readStdin.then(input => {
    return _.map(input, item => {
        if(!_.isPlainObject(item)) {
            var newItem = {};
            newItem[varName] = item;
            item = newItem;
        };

        var cmd = template(item);
        var stdOut = exec(cmd).toString();

        if(options["std-out"])
            process.stdout.write(stdOut);

        return stdOut.trim();
    });
})

if(!options["std-out"])
    chain.then(result => console.log(JSON.stringify(result, null, options.pretty ? 2 : undefined)));
